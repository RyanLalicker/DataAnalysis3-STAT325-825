---
title: "Data Analysis 3"
authors: 
  Maksuda Aktar Toma,
  Jo Charbonneau,
  Ryan Lalicker
date: today
date-format: long
execute: 
  echo: false
  warning: false
columns: 2
format:
  pdf: 
    fig-align: center
    fig-width: 6
    fig-height: 4
bibliography: references.bib
editor: 
  markdown: 
    wrap: sentence
---

```{r, , fig.pos="H"}
#| label: data-setup
#| echo: false
#| eval: true

library(knitr)
library(dplyr)
library(ggplot2)
library(naniar)
library(reshape2)
library(GGally)
library(janitor)
library(emmeans)
library(MASS)
library(multcomp)
library(lme4)
library(nnet)

data <- read.csv("data.csv")
# Placeholder of original data
origdata <- data
data <- data %>%
  mutate(across(everything(), ~ ifelse(. %in% c(".", ""), NA, .)))


```

```{r, , fig.pos="H"}
#| label: Scratch-work-1
#| echo: false
#| eval: false

length(unique(na.omit(data$Sire)))
length(unique(na.omit(data$Development.Treatment)))
sum(rowSums(is.na(data)) > 0)
rows_with_na <- sum(rowSums(is.na(data)) > 0)
unique_entries <- unique(data$Calan.Treatment)
num_unique <- length(unique_entries)
frequency_table <- table(data$Calan.Treatment)
```

# Introduction

In this paper we will be looking at data related to calves.
The data comes from an experiment designed to study the impact dietary treatments given to pregnant heifers had on the development of the calves.
The study was conducted over a three year period and involved three different dietary treatments given to select groups of heifers in the final trimester.
In total the data has 22 variables for 120 entires, though some data points are missing.

For more information on the experiment, the data, or any other files used in this paper see our [Github page](https://github.com/RyanLalicker/Data-Analysis-2-STAT-325-825) which can be found at <https://github.com/RyanLalicker/Data-Analysis-2-STAT-325-825>.
The coding languages used in the paper are R and SAS.
The corresponding code can be found in *Appendix A - R Code* and *Appendix B - SAS Code* respectively.

## Variables

The experiment used three different dietary treatments.
These were DDG, CON, and MET.
For the first two trimesters the heifers were given one of seven developmental treatments, found in `Development.Treatment`, and then in the final trimester the each was given one of the three treatments mentioned above.
This is recorded in the `Calan.Treatment` column of the dataset.

The heifers were placed into one of four pens by weight, which can be seen in the column `Pen #`.
They were then artificially inseminated from an assigned sire, which we will assume was done randomly since the client says weight was not a factor.
The sire is represented by the column of the same name and has six unique entries.

Upon the birth of the calves, several measurements were taken.
These include the sex of the calf, weights taken at both birth and slaughter, and scores of both the calf's vigor and the ease of birth.
The vigor score is on a scale of one to eleven where a score of one is very good and a score of ten or eleven indicates poor vitality for the calf.
(@Vigor).
The ease score goes from one to five where one indicates a quick and easy birth, two means a longer birth, three means requires some assistance, and four or five indicates more assistance was needed.
(@Ease).
Note, the variable names in the dataset line up with the descriptions above.

Other variables, such as the id of the calf, length of gestation for the heifer, and postmortem scoring such as hot carcass weight (HCW) are included as well.
(@UNLBeef).
Note two birthdays are included in the data, `Birth.date` and `Birth.date.1`.
These variables will not be used in the models below so no further investigation was done on our part to determine the differences.

The client's main focus is the effect the third trimester treatment and the sex of a calf have on the calf's vigor score, ease of birth score, and final body weight.
Therefore, these are the variables we will place more of an emphasis on, while exploring the effect some of the other variables may have.

## Missing Values

The data contains some missing values.
In total 53 rows in the dataset are missing at least one variable.
@fig-missing-data shows which columns have the most missing data.
As we can see the values for the variable `DMI`, which according to the USDA represents the dry matter intake for a cow, is missing for two-thirds of the entries.
(@USDA).
Given the number of missing values is this large, it is probably best to not use this variable in our models.
Some other variables, including the final body weight of the calf represented by `Final.Calf.BW`, are missing in 19 entries.
Of the other four variables the client was most interested in, none have more than ten missing values.

```{r, , fig.pos="H"}
#| label: fig-missing-data
#| fig-cap: "Chart counting the number of missing values for each variable within the data."
#| echo: false
#| eval: true
#| fig-width: 5
#| fig-height: 3

gg_miss_var(data) +
  ggtitle("Missing Data Distribution") +
  theme_minimal()

```

## Cleaning the Dataset

```{r,,fig.pos="H"}
#| label: cleaning
#| echo: false
#| eval: true

var_used <- c("Calan.Treatment", "SEX", "Calving.Ease", "Calf.Vigor", "Final.Calf.BW", "Pen..", "Initial.BW", "Sire")
cleaned_data <- data[complete.cases(data[, var_used]), ]

```

Due to the missing values discussed above, we need to clean this dataset before continuing.
There are several ways to handle missing values.
One way is imputing them with some metric like the mean, median, or mode of the variable.
Another is to just remove any rows with missing data.

We decided to cut all rows that contained missing values for variables we are interested in.
These variables include the five variables the client is interested in, but also the pen number, sire, and the initial weight of the mother.
The latter two are `Sire` and `Initial.BW` in the dataset.
After removing missing values for these entries the dataset has 101 rows, which we feel is an ample amount for analyzing the data.
Note all future figures and models come from this cleaned dataset and not the original.

We initially considered imputing the quantitative variables with the respective median values and using the mode for categorical variables as @MEMON2023101382 suggests.
This has some issues though.
For an example let's consider the third trimester treatment.
The MET treatment was used in 40 cases, while the other two treatments were only used 38 times, meaning there are four missing values.
If we mode impute this variable there will be 42 instances of the MET treatment.
However, it seems very possible that the missing entries were split between the CON and DDG treatments to make an even 40 uses each.
While imputing quantitative variables is less risky, we are not fully comfortable with that approach either since we are trying to analyze the data.

## Summary Statistics

Let's take a closer look at what the three dependent variables the client is interested in.
@fig-summary-stats shows several summary statistics for each.
Looking at the maximum values of the calving ease and calf vigor, we can see that the cleaned dataset does not contain any instances of poor scores for either.
Both scores only goes from one to three.
Note, the original dataset did have three instances of a vigor score of four or five, but each row was missing a final body weight so the entries were not included in the cleaned dataset.
We can also see from the median and 75th percentiles that both seem very skewed towards the low end of the scale.
While this is a good thing in terms of the health of the cows it could present some challenges for us later on.

```{r, , fig.pos="H"}
#| label: fig-summary-stats
#| echo: false
#| eval: true

dep_vars <- c("Calving.Ease", "Calf.Vigor", "Final.Calf.BW")

custom_names <- c("Calving Ease", "Calf Vigor", "Final Calf Weight")

cleaned_data$Calving.Ease <- as.numeric(cleaned_data$Calving.Ease)
cleaned_data$Calf.Vigor <- as.numeric(cleaned_data$Calf.Vigor)
cleaned_data$Final.Calf.BW <- as.numeric(cleaned_data$Final.Calf.BW)

calc_stats <- function(var) {
  mean_val <- mean(var, na.rm = TRUE)
  median_val <- median(var, na.rm = TRUE)
  sd_val <- sd(var, na.rm = TRUE)
  quantiles <- quantile(var, probs = c(0.25, 0.75), na.rm = TRUE)
  max <- max(var, na.rm = TRUE)
  min <- min(var, na.rm = TRUE)
  c(mean = mean_val, median = median_val, sd = sd_val, Q1 = quantiles[1], Q3 = quantiles[2], Min = min, Max = max)
}

summary_table <- t(sapply(dep_vars, function(var) calc_stats(cleaned_data[[var]])))

summary_table <- as.data.frame(summary_table)

kable(summary_table, col.names = c("Variable", "Mean", "Median", "SD", "25th Percentile", "75th Percentile", "Min", "Max"), 
      caption = "Summary statistics for dependent variables")

```

The final weight of calf is the third variable in @fig-summary-stats.
The mean and median are relatively similar given the large standard deviation.
While the previous two variables discussed give us some concerns about the skew, the final weight does not present the same issues.
Further investigation into the approximate distribution of the final weight is needed though.

Let's look at a histogram and a Q-Q plot for the final weight of the calves in @fig-normality.
The bin width for the histogram comes from the Freedman-Diaconis rule.
(@Freedman).
The histogram appears to follow an approximately normal distribution.
The Q-Q plot mostly follows this as most points follow the linear trend represented by the red line.

```{r, , fig.pos="H"}
#| label: fig-normality
#| echo: false
#| eval: true
#| fig-cap: "Plots used to check if the distribution of the final calf weight is normal."
#| layout-ncol: 2
#| fig-subcap: 
#|  - "Histogram of final calf weight."
#|  - "Q-Q plot of final calf weight."
#| fig-width: 6
#| fig-height: 4

bin_width <- round(2*IQR(cleaned_data$Final.Calf.BW)/(length(cleaned_data$Final.Calf.BW))^(1/3), 2)

ggplot(cleaned_data, aes(x = Final.Calf.BW)) +
  geom_histogram(binwidth = bin_width, color = "black", fill = "skyblue") +
  labs( title = "Histogram of final calf weight",
    x = "Weight",
    y = "Frequency"
  ) +
  theme_minimal()

ggplot(cleaned_data, aes(sample = Final.Calf.BW)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(title = "Q-Q plot of final calf weight",
    x = "Theoretical Quantiles",
    y = "Sample Quantiles"
  ) +
  theme_minimal()


```

Before moving on we want to look at plots of the scoring variables as well.
While we suspect a heavy skew for each, the histograms in @fig-scoring-dist verify this.
It is important to remember that these two variables are not continuous like the weight variable, so the types of models used will vary.

```{r, , fig.pos="H"}
#| label: fig-scoring-dist
#| echo: false
#| eval: true
#| fig-cap: "Histograms of scoring variables."
#| layout-ncol: 2
#| fig-subcap: 
#|  - "Histogram of calving ease."
#|  - "Histogram of calf vigor."
#| fig-width: 6
#| fig-height: 4


ggplot(cleaned_data, aes(x = Calving.Ease)) +
  geom_histogram(binwidth = 1, color = "black", fill = "skyblue") +
  labs(title = "Histogram of calving ease",
    x = "Ease Score",
    y = "Frequency"
  )+
  theme_minimal()

ggplot(cleaned_data, aes(x = Calf.Vigor)) +
  geom_histogram(binwidth = 1, color = "black", fill = "skyblue") +
  labs(title = "Histogram of calf vigor",
    x = "Vigor Score",
    y = "Frequency"
  ) +
  theme_minimal()


```

## Exploring the Data

Before looking at potential models, let's explore how some of the variables interact with each other.
While we will be able to include other explanatory variables, the client specifically mentions using the third trimester treatment and the sex of a calf as explanatory variables of interest.
The table in @fig-table shows the breakdown of treatment by sex.
Note HFR stands for heifer and STR stands for steer.
Although not every group has an equivalent number of subjects, this is nothing we are concerned about.
Please note that the total occurrences per treatment are different than discussed above since rows containing missing values were removed.

```{r, , fig.pos="H"}
#| label: fig-table
#| echo: false
#| eval: true
#| fig-cap: "Table showing the breakdown of treatment by sex."


data2 <- cleaned_data

crosstab_treatment_sex <- table(data2$Calan.Treatment, data2$SEX)

kable(
  crosstab_treatment_sex)


```

One of the key assumptions for regression models is that the explanatory variables should not be highly correlated to avoid multicollinearity.
Here, we used a Pearson's Chi-squared test to examine the association between the categorical variables `Calan.Treatment` and `SEX`.
The p-value (0.40811) suggests that there is no statistically significant association between these variables.
While this result indicates that these variables are not strongly associated, it does not directly address multicollinearity, which is better assessed using metrics like Variance Inflation Factor (VIF) or condition indices in regression models.
Therefore, we will do further diagnostic checks for the model, such as calculating VIF values, to ensure multicollinearity is not an issue in the model.

```{r, , fig.pos="H"}
#| label: fig-chi
#| echo: false
#| eval: true
#| fig-cap: "Chi-squared test for treatment and sex."


chi_sq_test <- chisq.test(crosstab_treatment_sex)
chi_sq_table <- data.frame(
  Metric = c("Statistic", "Degrees of Freedom", "P-Value"),
  Value = c(round(chi_sq_test$statistic, 2), 
            chi_sq_test$parameter, 
            format.pval(chi_sq_test$p.value)),
  stringsAsFactors = FALSE
)

kable(chi_sq_table, align = c("l", "c"), row.names = FALSE)

```

Now let's consider how these variables affect the final Calf body weight.
The boxplot shown in @fig-box-1 allows us to see this relationship graphically.
We can see the steers are heavier on average than the heifers.
The treatments seem to different variances as well, but their median values are not different by huge quantities.
Both the CON and MET treatments had one steer large enough to be an outlier, while the DDG treatment had several outliers for both sexes.

```{r, , fig.pos="H"}
#| label: fig-box-1
#| echo: false
#| eval: true
#| fig-cap: "Boxplot of final Calf body weight by treatment and sex."
#| fig-width: 6
#| fig-height: 4

ggplot(data2, aes(x = Calan.Treatment, y = Final.Calf.BW, fill = SEX)) +
  geom_boxplot(outlier.color = "red", alpha = 0.7) +
  labs(title = "Boxplot of Final Calf Body Weight by Treatment and Sex",x = "Treatment", y = "Final Body Weight") +
  theme_minimal()

```

Another variable we want to investigate graphically is the initial weight of the heifer that birthed the calf and see how it compares to both the ease and vigor score.
In @fig-bodyweight-scatter we can see this while also accounting for both the third trimester treatment with the shape of the data point and the sex of the calf with the color of the data point.
This allows us to see, how the effect of the heifer's initial weight has, but also the trends of both treatment and sex.

```{r, , fig.pos="H"}
#| label: fig-bodyweight-scatter
#| echo: false
#| eval: true
#| fig-cap: "Scatterplot of heifer's initial body weight versus scoring variables, controlling for third trimester treatment and sex of the calf."
#| fig-width: 6
#| fig-height: 4
#| layout-ncol: 2
#| fig-subcap: 
#|  - "Initial body weight vs. calf vigor."
#|  - "Initial body weight vs. calving ease."

data2$Initial.BW <- as.numeric(data2$Initial.BW)

ggplot(data2, aes(x = Calving.Ease, y = Initial.BW, color = SEX, shape = Calan.Treatment)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(x = "Calving Ease", y = "Initial Body Weight of Heifer") +
  theme_minimal()

ggplot(data2, aes(x = Calf.Vigor, y = Initial.BW, color = SEX, shape = Calan.Treatment)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(x = "Calf Vigor", y = "Initial Body Weight of Heifer") +
  theme_minimal()


```

In both plots, we can see the initial weight of the mother heifer does not seem to have a huge effect on either score.
It would appear that being heavier or lighter than average had little to no effect on getting a score other than one.
The clustering of data at the lowest levels (1) for both calving ease and calf vigor highlights the imbalance in these outcome variables, potentially limiting the ability to draw robust conclusions.
While this variable may be used in models later to test its significance more formally, we have doubts about its effect on either score variable.

# Models for Calving Ease Score

## Ordinal Logistic Regression Model

Since calving ease is a score from one to three in our dataset and one to five in real life, it can be considered an ordinal variable.
This means instead of treating it as a quantitative variable as we did previously, it could be considered an ordered categorical variable.
One method of modeling ordinal variables is with ordinal logistic regression.
This uses one or more independent variables to predict the ordinal value of the dependent variable.
A key assumption of ordinal logistic regression, outside of the dependent variable being ordinal, is no multicollinearity between independent variables.
(@StAndrews).

Let's attempt to apply an ordinal logistic regression to the calving ease variable.
In this simple case, we will use the third-trimester treatment and the calf's sex as the independent variables.

Ordinal logistic regression models are expressed as a logit function containing probabilities rather than a single variable.
In this case, where $Y$ is a random variable representing the calving ease score and $l=1,2,...,5$ represents the possible values of $Y$ in theory and $l=1,2,3$ in our dataset, $\frac{P(Y \leq l)}{P(Y > l)}$ is the cumulative probability of the easing score being less than or equal to level $l$ versus greater than $l$.
We can then write the model as

$$
\ln\left(\frac{P(Y \leq l)}{P(Y > l)}\right)=
\alpha_l-\beta_{trt}X_{trt}-\beta_{sex}X_{sex}-\beta_{trt:sex}(X_{trt} \times X_{sex})
$$

The equation above the left side is the log odds or log of the cumulative probability, the logit function mentioned previously.
On the right side of the equation $\alpha_l$ is the intercept of the model at the $l$th level, $X_{trt}$ and $X_{sex}$ represent the values for the treatment, and the sex respectively, and the $\beta_i$ are slope values corresponding to the $i$th explanatory variable with $\beta_{trt:sex}$ being the interaction effect.

Some of the results of the model are displayed in @fig-OLS-Ease.
Note the model treats CON and heifer as the starting values for the treatment and sex respectively.
The first three rows of the coefficients table report the main effects of the other two treatments and steers.
`Calan.TreatmentDDG: SEXST` respresnts the interaction effect between the DDG treatment and steers, which is highly significant (p-value \< 0.001).
The interaction between the MET treatment and steers is not significant, though (p-value = 0.149).
Overall, the model highlights significant effects for DDG and its interaction with calf sex, while other predictors do not show substantial influence.

```{r, , fig.pos="H"}
#| label: fig-OLS-Ease
#| echo: false
#| eval: true
#| fig-cap: "Coefficients table for ordinal logistic regression."


library(MASS)
data2$Calving.Ease <- factor(data2$Calving.Ease, ordered = TRUE)

ease_model_3 <- polr(Calving.Ease ~ Calan.Treatment * SEX, data = data2, Hess = TRUE)

summary(ease_model_3)

coefs <- coef(summary(ease_model_3))
p_values <- pnorm(abs(coefs[, "t value"]), lower.tail = FALSE) * 2  # Two-tailed p-values
coefs <- cbind(coefs, "p-value" = p_values)


kable(coefs, 
      digits = 3,  
      format = "markdown")

```

The last two rows of @fig-OLS-Ease provide estimates for the model's interests.
For instance the row `1|2` means for $l<=1$ the model estimates $\alpha_1=1.735$ and for $l<=2$ we can say $\alpha_2=2.939$.
Both of these intercepts are significant as well.

In summary of this model, we found a substantial difference between heifer calves from mothers on the CON treatment compared to steer calves with mothers on the DDG treatment as it relates to the easing score.
The DDG steer interaction effect had an estimated positive coefficient, but in the context of the model, this implies a decrease in the log odds.
However, the MET treatment did not have a statistically significant effect.

The Residual Deviance value of 65.95121 measures the goodness of fit for the model, where lower values indicate a better match between the observed and predicted data.
The Akaike Information Criterion (AIC) of 79.95121 evaluates the trade-off between the model's fit and complexity, with smaller AIC values indicating a more efficient model.We'll compare this AIC value with other models later.
(@OLR).

## Multinomial Logistic Regression (MLR)

In search of another model, we considered a multinomial logistic regression.

The multinomial logistic regression model predicts Calving Ease based on Calan.Treatment, SEX, and their interaction.
The model converged successfully after several iterations, with a residual deviance of 58.418 and an AIC of 82.418 (Whice is larger than OLR Model).It's indicating MLR is not a good choice for fitting the model.
Coefficients represent the log-odds of the calving ease levels relative to a reference category, but the large standard errors for interaction terms suggest potential numerical instability or sparse data for some levels.

Another important thing is that the Multinomial logistic regression is designed to model nominal data, which is categorical data without an order.
We could still choice this Model for our ordinal variable (Calving Ease), if it would be better fitting than OLR Model (@Multi).
For these reasons, we chose to go in another direction and not recommend this model.

```{r}
library(nnet)
ease_model_4 <- multinom(Calving.Ease ~ Calan.Treatment * SEX, data = data2)
summary(ease_model_4)
```

## Binomial Regression

As previously discussed, the data for the calving ease score is highly skewed with most calves getting a score of one.
One way to reduce the effect of the skew could be to convert this to a binomial data set.
In this case we would have two categories for the calving ease score: low, which corresponds to scores of one, and high, which is everything else.
A type of model that fits binomial data like this is a binomial regression.
While this may not make a huge difference given that we have no scores larger than three, we want to see how this model compares to the last.

For this model, we chose to use the same two explanatory variables, third trimester treatment and sex of the calf.
In this case let $\pi$ be the probability of a high score given the explanatory variables, $X_{trt}$ and $X_{sex}$ respectively.
In other words $\pi=P(Y=high|X_{trt},X_{sex})$ where $Y$ is the same random variable as before, but is only ever $low$ or $high$.
Binomial regression uses $\pi$ in a similar logit function as the ordinal logistic regression.
Thus we can write the model as,

$$
\ln \left( \frac{\pi}{1-\pi} \right) = \beta_0 + \beta_1 X_{trt} + \beta_2 X_{sex}+\beta_3(X_{trt} \times X_{sex})
$$ where $\beta_0$ is the intercept of the model and $\beta_1$, $\beta_2$ and $\beta_3$ are the coefficients for $X_{trt}$, $X_{sex}$, and their interaction respectively.
(@bino).
For this model MET is considered to be the default treatment, while steer is the default sex.

![*Fit Statistics* and other tests.](Bin.ease-1.png)

In the *Joint Tests* table above we can see the interaction terms are insignificant.
This means we can look at main effects for each variable level.
These can be seen in the *Analysis of Maximum Likelihood Estimates* below, but all terms outside of the intercept are insignificant as well.

![*Analysis of Maximum Likelihood Estimates* table.](Bin.eas-2.png)

Elsewhere in the output, which can be seen in *Appendix C - Additional SAS Output*, the odds ratios and subsequent confidence intervals also indicated no significant results.

While the lack of significant terms seems detrimental, the AIC of the model is 66.599, indicating a decent fit.
However, we cannot compare this value to the AIC of the ordinal logistic model since they are different types of models.
(@aic).
This is backed up by the percent concordance (63.9%) and Somers' D (0.440), which suggest moderate predictive performance.
Later the odds ratio plot visually confirms the lack of significant associations for the predictors and their interactions.

![*Plot for Odds Ratio*](Bin.eas-4.png)

```{r}
data2$Calving.Ease.bin <- factor(ifelse(data2$Calving.Ease == 3 | data2$Calving.Ease == 2, 2, 1), 
                           levels = c(1, 2), 
                           labels = c("Low", "High"))
binary_model_ease <- glm(Calving.Ease.bin ~ Calan.Treatment * SEX, data = data2, family = binomial)
summary(binary_model_ease)
```

### Checking Assumption for Binomial

The Cook's Distance plot shows that most observations have minimal influence on the model, with no Cook's distances exceeding common thresholds (e.g., 0.5), indicating no highly influential data points.
The Deviance Residuals plot demonstrates that most residuals are centered near zero, reflecting a generally good model fit, but a few residuals exceed ±2, which may indicate potential outliers or areas of poor model performance.
The Variance Inflation Factor (VIF) analysis highlights severe multicollinearity for Calan.Treatment (GVIF = 50.03) and its interaction with SEX (GVIF = 58.34), suggesting strong redundancy among these predictors.
In contrast, the VIF for SEX (1.68) indicates no significant multicollinearity for this variable alone.
Overall, while the model does not appear to have issues with influential points, the presence of multicollinearity among predictors could complicate interpretation and may necessitate further investigation or variable transformation.

```{r}

# 3. Influential observations (Cook's Distance)
influence <- cooks.distance(binary_model_ease)
plot(influence, type = "h", main = "Cook's Distance")
abline(h = 4 / nrow(data2), col = "red")  # Threshold for influential points


# 5. Residual analysis (deviance residuals)
plot(residuals(binary_model_ease, type = "deviance"), main = "Deviance Residuals")
abline(h = 0, col = "red")

# 2. Multicollinearity
library(car)
vif(binary_model_ease)  # Variance Inflation Factor

```

## Conclusion for Calving Ease Score

We previously discussed three models for the calving ease score.
As we already indicated, the multinomial logistic regression is not the direction we would recommend.
Regarding to the other two, model preference depends on the cleint's desired goal.
If these models are intended for purely predictive purposes, the binomial regression model may be effective.
However, if the client wants to study the impact the third-trimester treatment and the sex of the calf had on the ease score, then we strongly recommend the ordinal logistic regression model over the other models discussed.

# Models for Calf Vigor Score

## Ordinal Logistic Regression Model

The similarities between the calving ease and calf vigor score make identifying potential models a much easier task, as what might fit calving ease score can also potentially fit the calf vigor score.
We will first look at an ordinal logistic regression model.
The model can once again be represented by the equation

$$
\ln\left(\frac{P(Y \leq l)}{P(Y > l)}\right)=
\alpha_l-\beta_{trt}X_{trt}-\beta_{sex}X_{sex}-\beta_{trt:sex}(X_{trt} \times X_{sex})
$$

since the client is interested in the effect of the same explanatory variables on the score.
This equation looks exactly the same as before, with the only changes being $Y$ now representing the calf vigor score and $l$ now ranging from one to eleven in real life.
(@Vigor).
Note, within out cleaned data set, $l=1,2,3$ as it did for the ease score.

While the dependent variable and equation are very similar to what we previously did the results of the model are not.
In @fig-OLS-Vigor we can see the interaction terms are non-significant.
The same can be said for the main effects meaning only the intercepts, $\alpha_l$, are significant.
This indicates neither of the explanatory variables seems to have much of an effect on the vigor score.

```{r, , fig.pos="H"}
#| label: fig-OLS-Vigor
#| echo: false
#| eval: true
#| fig-cap: "Coefficients table for ordinal logistic regression."

data2$Calf.Vigor <- factor(data2$Calf.Vigor, ordered = TRUE)

vigor_model_1 <- polr(Calf.Vigor ~ Calan.Treatment * SEX, data = data2, Hess = TRUE)

#summary(vigor_model_1)

# Extract p-values
coefs <- coef(summary(vigor_model_1))
p_values <- pnorm(abs(coefs[, "t value"]), lower.tail = FALSE) * 2  # Two-tailed p-values
coefs <- cbind(coefs, "p-value" = p_values)
#print(coefs)
kable(coefs, 
      digits = 3,  
      format = "markdown")

```

Additionally, the model returned an AIC of 127.059.
This is not bad on its own and indicates the model fits decently.
However, the issues regarding significance make us skeptical of the model's predictive capability.
It may indicate that the two explanatory variables just do not significantly impact the vigor score.
We will want to test other models before arriving at that conclusion, though.

## Binomial Regression

Given the lack of significance with the ordinal logistic regression model, we will look into the binomial example again.
As before, we are condensing the vigor score into a low category and a *high* category.
All of the scores of one fit in the former and the rest are in the latter.
Just as with the calving ease score, let $\pi$ be the probability of a high score.
Then, by using the same two explanatory variables again, we can write the model as

$$
\ln \left( \frac{\pi}{1-\pi} \right) = \beta_0 + \beta_1 X_{trt} + \beta_2 X_{sex}+\beta_3(X_{trt} \times X_{sex})
$$

Once again, the *Analysis of Maximum Likelihood Estimates* table below indicates no significant interactions or main effects, outside of the intercept.
Again though, the *Model Fit Statistics* table has a decent AIC store, so the model may still have predictive qualities despite showing no significant relationships among our explanatory variables.

![*Fit Statistics* and other tests](Bin.vig-1.png)

![*Analysis of Maximum Likelihood Estimates* table.](Bin.vig-2.png)

More of the SAS output, including odds ratios and plot can be found in *Appendix C - Additional SAS Output*.

```{r}
data2$Calf.Vigor <- factor(ifelse(data2$Calf.Vigor == 3 | data2$Calf.Vigor == 2, 2, 1), 
                           levels = c(1, 2), 
                           labels = c("Low", "High"))
binary_model1 <- glm(Calf.Vigor ~ Calan.Treatment * SEX, data = data2, family = binomial)
summary(binary_model1)

```

## Checking Assumption for Calf Vigor

The Variance Inflation Factor (VIF) values for all predictors and their interaction are below 5, implying no significant multicollinearity in the model.
The adjusted GVIF values for the interaction term (1.71), Calan.Treatment (1.42), and SEX (1.74) confirm that the predictors do not distort coefficient estimates due to collinearity.The Cook's Distance plot indicates that all observations have minimal influence on the model, with no notable outliers or highly influential points.
The Deviance Residuals plot shows residuals tightly clustered around zero, suggesting an excellent model fit, though the lack of variability might indicate overfitting or an overly simplistic model specification.
Overall, the diagnostics support the validity of the model, but the small deviance residuals may require further investigation to ensure appropriate model fit.

```{r}
# 2. Multicollinearity
library(car)
vif(binary_model1)  # Variance Inflation Factor

# 3. Influential observations (Cook's Distance)
influence <- cooks.distance(binary_model1)
plot(influence, type = "h", main = "Cook's Distance")
abline(h = 4 / nrow(data2), col = "red")  # Threshold for influential points


# 5. Residual analysis (deviance residuals)
plot(residuals(binary_model1, type = "deviance"), main = "Deviance Residuals")
abline(h = 0, col = "red")

```

## Conclusion for Calf Vigor Score

The two models discussed above both had a similar conclusion, which is the vigor score was not significantly affected by either the third trimester treatment, the cal's sex, or their interaction.
Therefore recommendation a model for this dataset will again depend on Client's goal.
However, both models could still have some predictive value, which could be evaluated at a later date.

Note that we did fit a multinomial logistic regression model for the vigor score as well, but we ran into the same issues as before so no results are shown for the model in this paper.

# Models for Final Calf Body Weight

## Mixed Model

Now, we will look at models for investigating the effect the client's chosen explanatory variables have on the final body weight of the calf.
Since the body weight is a quantitative variable, we can turn to linear models.
We initially attempted to fit a simple model using only the third-trimester treatment and sex of the calf but ultimately chose to include the calf's sire as an additional explanatory variable.
This slightly complicates the model as we believe the additional variable is better represented as a random effect, meaning we are working with a mixed model.

The proposed model and be represented as $$
Y_{ijk} = \mu + \alpha_i + \beta_j + (\alpha \beta)_{ij}+u_k+e_{ijk}
$$ where $Y_{ijk}$ represents the final weight for the $ith$ treatment, the $j$th sex, and the $k$th sire.
$\mu$ represents the overall mean, while $\alpha_i$ is the fixed effect for the $ith$ treatment, $\beta_j$ is the fixed effect for the $j$th sex, and $(\alpha \beta)_{ij}$ is their interaction.
The random sire effect is represented by $u_k$ and we assume $u_k~N(0,\sigma_k^2)$.
We also assume the residual term $e_{ijkl}$ is distributed as $~N(0,\sigma^2)$.

For a linear mixed model to work, the assumption regarding the distribution of the residuals must hold.
These can be checked graphically in the conditional residual plots below.
The histogram and Q-Q plot show if the residuals are approximately normal, while the plot in the top left evaluates any multicollinearity concerns.
Thankfully the graphs give us no concerns as no trends are present in the top-left plot and the residuals are randomly distributed around zero, the histogram appears bell shaped around zero, and the Q-Q plot sees most points fall along the line, which is ideal.
Therefore we can procede with our mixed model.

![Plots to check residual assumption.](mix.res.png)

The *Covariance Parameter Estimates* table shows how the sire effect

From the *Fit Statistics* table below shows the model has an AIC of 1193.1.
While this is not great, it is not far off from other models we have viewed in other data analyses.
Also, the sire effect on the covariance structure is shown in the *Covariance Parameter Estimates* table.

![Covariance parameter, fit statistics, fixed effects, and least squares mean tables](Mix-1.png)

The *Type 3 Fixed Effects* table tells us what fixed effects, if any, are statistically significant.
As we have done when viewing other models in this paper, we must first look at the interaction effect, which is insignificant.
Therefore, we turn to the main effects of the two explanatory variables.
While the sex of the calf is highly significant (p-value \< 0.0001), the treatment effect is insignificant.
Given that the interaction is insignificant, we chose not to evaluate the *Differences of the Least Squares Means* table, but we did include it in *Appendix C - Additional SAS Output* for the transparency.

## ANCOVA Model

Another model that could fit the data is an ANCOVA model.
These models take a continuous dependent variable and take at least one categorical variable along with a covariate.
The dependent and categorical variables will once again be the third-trimester treatment and sex of the calf.
The covariate must be a continuous, independent variable that is not a primary interest of the study.
(@ancova).
We previously looked at the mother heifer's initial body weight in @fig-bodyweight-scatter, so we will make that the covariate.

The proposed ANCOVA model can be represented as:

$$
Y_{ijk} = \mu + \alpha_i + \beta_j + (\alpha \beta)_{ij} + \gamma X_k + e_{ijk}
$$

where $Y_{ijk}$ represents the final Calf Body weight for the $ith$ treatment, the $j$th sex, and the $k$th initial.BW.
$\mu$ represents the overall mean, while $\alpha_i$ is the fixed effect for the $ith$ treatment, $\beta_j$ is the fixed effect for the $j$th sex, and $(\alpha \beta)_{ij}$ is their interaction.
$$\gamma X_k $$ is Covariate effect of initial body weight where $$\gamma$$ is the slope.We assume the residual error term $e_{ijkl}$ is distributed as $~N(0,\sigma^2)$.

This ANCOVA model adjusts the response variable $Y{ijk}$ (final calf body weight) for the covariate initial body weight $X_k$ while modeling the main effects of treatment $\alpha_i$ , sex $\beta_j$ , and their interaction $(\alpha \beta)_{ij}$.
The residual errors are assumed to be normally distributed with constant variance.

Now, we can view the output of this model after it was fit in SAS.

![*Model information along with Type I and Type III test results.*](an.1.png)

The ANCOVA model for Final_Calf_BW is significant overall, with an F-value of 5.72 and a p-value \< 0.0001, indicating that the predictors collectively explain a significant portion of the variability in final calf body weight.
The R-Square value of 0.267 shows that 26.7% of the variability in Final_Calf_BW is accounted for by the model.
Among individual predictors, Calan.Treatment (p=0.5922), SEX (p=0.6701), and their interaction (p=0.7179) are not statistically significant, suggesting they do not contribute meaningfully to explaining Final_Calf_BW.
However, Initial BW is a significant predictor (p=0.0022), highlighting its importance in determining final body weight.
This emphasizes that initial body weight is a key variable driving differences in Final_Calf_BW, while treatment and sex effects appear negligible.

![*ANCOVA Plot-1*](an.2.png)

This ANCOVA plot examines the relationship between Initial Body Weight (Initial BW) and Final Calf Body Weight (Final_Calf_BW) for combinations of Calan.Treatment and SEX.
Each line represents a fitted regression line, showing how Initial BW influences Final_Calf_BW for each group.
The generally parallel nature of the lines indicates no significant interaction between Calan.Treatment and SEX, as the slopes are similar across groups.
The positive slopes demonstrate that Initial BW is a strong predictor of Final_Calf_BW, with higher initial weights leading to higher final weights.
There is some variability within each group, as shown by the scatter of points around the lines, but overall, Initial BW appears to adjust group differences effectively.

![\* Tukey-Kramer adjustments plot\*](an.5.png)

The plot displays pairwise comparisons of Final_Calf_BW across treatment and sex combinations, using Tukey-Kramer adjustments for multiple comparisons.
Red lines represent comparisons where the differences between groups are not statistically significant, while blue lines indicate significant differences at the 0.05 level.
The majority of comparisons are not significant, as evidenced by the predominance of red lines.
However, some significant differences are noted, such as between MET STR and CON HFR. Overall, the visualization demonstrates that while certain treatment-sex combinations show significant differences, the interaction effect between treatment and sex does not exhibit a strong pattern of significance, supporting the earlier conclusion of non-significant interaction effects.

### Checking Assumptions

![*Residuals vs Predicted Plot*](an.res-1.png)

This scatter plot of residuals against predicted values checks for homoscedasticity (constant variance of residuals).
The residuals are scattered relatively evenly around the zero line, showing no clear pattern or trend, which supports the assumption of homoscedasticity.
However, there are a few residuals at the extremes that may warrant closer inspection for influential data points.

![*Univariate Statistics and Tests for Residuals*](an.res-2.png)

The univariate statistics for residuals indicate that the mean is 0, with small skewness (0.31) and kurtosis (0.88), suggesting no systematic bias and approximate normality in the residuals.
Tests for location (e.g., t-test, Sign test) confirm that the mean residual is not significantly different from 0, as all p-values exceed 0.05.
Additionally, normality tests (Shapiro-Wilk, Kolmogorov-Smirnov, etc.) also yield p-values greater than 0.05, further supporting the assumption of normally distributed residuals.

![Histogram](an.res-3.png) 

The histogram shows the distribution of residuals, which appears approximately symmetric and bell-shaped.
The overlaid normal curve aligns well with the histogram, further supporting the assumption of normality.

![*Q-Q Plot*](an.res-4.png) 

Most points lie close to the diagonal line, indicating normality.
However, slight deviations at the tails suggest minor departures from normality, but these are not severe enough to invalidate the model assumptions.

The diagnostic plots and tests collectively support that the assumptions of homoscedasticity, normality, and zero-mean residuals are reasonably met.
While minor deviations are observed, they are unlikely to significantly impact the validity of the model.

# Summary

Add if you have any! Otherwise delete this section

# Recommendation

The analysis identified Initial_BW as the most significant predictor of Final_Calf_BW, emphasizing the importance of optimizing maternal nutrition during pregnancy to improve calf growth outcomes. Dietary treatments (CON, DDG, MET) showed no significant effect on Final_Calf_BW, suggesting a need to revisit their formulation or timing if they are to make a meaningful impact. Sex differences were significant, with males (steers) outperforming females (heifers), indicating the potential for tailored management practices to enhance growth. Sire effects explained minimal variability and may not need inclusion in future models unless biologically justified. The ANCOVA model offered clear and interpretable results, making it a recommended approach for future studies, while also suggesting further trials with revised treatments and additional predictors to better understand growth variability.

\newpage

# References

::: {#refs}
https://stats.oarc.ucla.edu/r/dae/ordinal-logistic-regression/ https://documentation.sas.com/doc/en/pgmsascdc/9.4_3.5/statug/statug_logistic_examples03.htm https://web.pdx.edu/\~newsomj/mvclass/ho_ancova%20example.pdf https://pmc.ncbi.nlm.nih.gov/articles/PMC7475459/
:::

\newpage

# Appendix A - R Code

```{r, , fig.pos="H"}
#| label: appendix A
#| echo: true
#| eval: false
library(knitr)
library(dplyr)
library(ggplot2)
library(naniar)
library(reshape2)
library(GGally)
library(janitor)
library(emmeans)
library(MASS)
library(multcomp)
library(lme4)
library(nnet)

data <- read.csv("data.csv")
# Placeholder of original data
origdata <- data
data <- data %>%
  mutate(across(everything(), ~ ifelse(. %in% c(".", ""), NA, .)))

length(unique(na.omit(data$Sire)))
length(unique(na.omit(data$Development.Treatment)))
sum(rowSums(is.na(data)) > 0)
rows_with_na <- sum(rowSums(is.na(data)) > 0)
unique_entries <- unique(data$Calan.Treatment)
num_unique <- length(unique_entries)
frequency_table <- table(data$Calan.Treatment)

gg_miss_var(data) +
  ggtitle("Missing Data Distribution") +
  theme_minimal()

var_used <- c("Calan.Treatment", "SEX", "Calving.Ease", 
              "Calf.Vigor", "Final.Calf.BW", "Pen..", "Initial.BW", "Sire")
cleaned_data <- data[complete.cases(data[, var_used]), ]

dep_vars <- c("Calving.Ease", "Calf.Vigor", "Final.Calf.BW")

custom_names <- c("Calving Ease", "Calf Vigor", "Final Calf Weight")

cleaned_data$Calving.Ease <- as.numeric(cleaned_data$Calving.Ease)
cleaned_data$Calf.Vigor <- as.numeric(cleaned_data$Calf.Vigor)
cleaned_data$Final.Calf.BW <- as.numeric(cleaned_data$Final.Calf.BW)

calc_stats <- function(var) {
  mean_val <- mean(var, na.rm = TRUE)
  median_val <- median(var, na.rm = TRUE)
  sd_val <- sd(var, na.rm = TRUE)
  quantiles <- quantile(var, probs = c(0.25, 0.75), na.rm = TRUE)
  max <- max(var, na.rm = TRUE)
  min <- min(var, na.rm = TRUE)
  c(mean = mean_val, median = median_val, sd = sd_val, 
    Q1 = quantiles[1], Q3 = quantiles[2], Min = min, Max = max)
}

summary_table <- t(sapply(dep_vars, function(var)
  calc_stats(cleaned_data[[var]])))

summary_table <- as.data.frame(summary_table)

kable(summary_table, col.names = c("Variable", "Mean", 
                                   "Median", "SD", "25th Percentile", 
                                   "75th Percentile", "Min", "Max"), 
      caption = "Summary Statistics for Dependent Variables")

bin_width <- round(2*IQR(cleaned_data$Final.Calf.BW)/
                     (length(cleaned_data$Final.Calf.BW))^(1/3), 2)

ggplot(cleaned_data, aes(x = Final.Calf.BW)) +
  geom_histogram(binwidth = bin_width, color = "black", fill = "skyblue") +
  labs(
    x = "Weight",
    y = "Frequency"
  ) +
  theme_minimal()

ggplot(cleaned_data, aes(sample = Final.Calf.BW)) +
  stat_qq() +
  stat_qq_line(color = "red") +
  labs(
    x = "Theoretical Quantiles",
    y = "Sample Quantiles"
  ) +
  theme_minimal()

ggplot(cleaned_data, aes(x = Calving.Ease)) +
  geom_histogram(binwidth = 1, color = "black", fill = "skyblue") +
  labs(
    x = "Ease Score",
    y = "Frequency"
  )+
  theme_minimal()

ggplot(cleaned_data, aes(x = Calf.Vigor)) +
  geom_histogram(binwidth = 1, color = "black", fill = "skyblue") +
  labs(
    x = "Vigor Score",
    y = "Frequency"
  ) +
  theme_minimal()

data2 <- cleaned_data

crosstab_treatment_sex <- table(data2$Calan.Treatment, data2$SEX)

kable(
  crosstab_treatment_sex)

chi_sq_test <- chisq.test(crosstab_treatment_sex)
chi_sq_table <- data.frame(
  Metric = c("Statistic", "Degrees of Freedom", "P-Value"),
  Value = c(round(chi_sq_test$statistic, 2), 
            chi_sq_test$parameter, 
            format.pval(chi_sq_test$p.value)),
  stringsAsFactors = FALSE
)

kable(chi_sq_table, align = c("l", "c"), row.names = FALSE)

ggplot(data2, aes(x = Calan.Treatment, y = Final.Calf.BW, fill = SEX)) +
  geom_boxplot(outlier.color = "red", alpha = 0.7) +
  labs(title = "Boxplot of Final Calf Body Weight by Treatment and Sex", 
       x = "Treatment", y = "Final Body Weight") +
  theme_minimal()

data2$Initial.BW <- as.numeric(data2$Initial.BW)

ggplot(data2, aes(x = Calving.Ease, y = Initial.BW, 
                  color = SEX, shape = Calan.Treatment)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(x = "Calving Ease", y = "Initial Body Weight of Heifer") +
  theme_minimal()

ggplot(data2, aes(x = Calf.Vigor, y = Initial.BW, 
                  color = SEX, shape = Calan.Treatment)) +
  geom_point(size = 3, alpha = 0.7) +
  labs(x = "Calf Vigor", y = "Initial Body Weight of Heifer") +
  theme_minimal()

data2$Calving.Ease <- factor(data2$Calving.Ease, ordered = TRUE)

ease_model_3 <- polr(Calving.Ease ~ Calan.Treatment * SEX, 
                     data = data2, Hess = TRUE)

#summary(ease_model_3)

coefs <- coef(summary(ease_model_3))
p_values <- pnorm(abs(coefs[, "t value"]), lower.tail = FALSE) * 2  
coefs <- cbind(coefs, "p-value" = p_values)

kable(coefs, 
      digits = 3,  
      format = "markdown")

data2$Calf.Vigor <- factor(data2$Calf.Vigor, ordered = TRUE)

vigor_model_1 <- polr(Calf.Vigor ~ Calan.Treatment * SEX, data = data2, Hess = TRUE)

summary(vigor_model_1)

coefs <- coef(summary(vigor_model_1))
p_values <- pnorm(abs(coefs[, "t value"]), lower.tail = FALSE) * 2  
coefs <- cbind(coefs, "p-value" = p_values)
#print(coefs)
kable(coefs, 
      digits = 3,  
      format = "markdown")
```

\newpage

# Appendix B - SAS Code

``` sas
/* Binomial Calving_Ease Model */
data data;
    set data;
    if 'Calving.Ease'n in (2, 3) then Binary_Ease = "High";
    else if 'Calving.Ease'n = 1 then Binary_Ease = "Low";
run;

proc freq data=data;
    tables Binary_Ease;
run;

/* Logistic regression model */
proc logistic data=data;
    class 'Calan.Treatment'n SEX / param=ref;
    model Binary_Ease(event='High') = 'Calan.Treatment'n|SEX;
    oddsratio 'Calan.Treatment'n;
    oddsratio SEX;
run;
```

``` sas
/*Binomial Calf Vigor*/
data data;
    set data;
    /* Recode Calf.Vigor: 1 = Low, 2 and 3 = High */
    if 'Calf.Vigor'n = 1 then Binary_Vigor = "Low";
    else if 'Calf.Vigor'n in (2, 3) then Binary_Vigor = "High";
run;

proc freq data=data;
    tables Binary_Vigor;
run;
data data;
    set data;
    Binary_Vigor = strip(Binary_Vigor);
run;
data data;
    set data;
    Binary_Vigor = propcase(Binary_Vigor); 
run;

proc logistic data=data descending;
    class 'Calan.Treatment'n SEX / param=ref;
    model Binary_Vigor = 'Calan.Treatment'n|SEX;
    oddsratio 'Calan.Treatment'n;
    oddsratio SEX;
run;
```

``` sas
/*Mixed Model*/
data data;
    set data;
    if not missing('Final.Calf.BW'n) then Final_Calf_BW = input('Final.Calf.BW'n, best12.);
run;

proc mixed data=data method=reml plots=residualpanel;
    class 'Calan.Treatment'n SEX Sire;
    model Final_Calf_BW = 'Calan.Treatment'n|SEX ;
    random intercept / subject=Sire;
    lsmeans 'Calan.Treatment'n*SEX / adjust=tukey pdiff;
run;
```

``` sas
/*ANCOVA*/
proc glm data=data ;
    class 'Calan.Treatment'n SEX;
    model Final_Calf_BW = 'Calan.Treatment'n|SEX 'Initial BW'n ;
    means 'Calan.Treatment'n / tukey cldiff;
    lsmeans 'Calan.Treatment'n*SEX / adjust=tukey pdiff cl;
    output out=diagnostics r=residuals p=predicted;
run;

/* Diagnostic plots */
proc sgplot data=diagnostics;
    scatter x=predicted y=residuals / markerattrs=(symbol=circlefilled);
    refline 0 / axis=y lineattrs=(color=red);
run;

proc univariate data=diagnostics normal;
    var residuals;
    histogram residuals / normal;
    qqplot residuals / normal(mu=est sigma=est);
run;
```

\newpage

# Appendix C - Additional SAS Output

## Binomial Regression Model for Calving Ease

![*Association of Predicted Probabilities and Observed Responses* and *Odds Ratio Estimates and Wald Confidence Intervals* tables.](Bin.eas-3.png)

![*Odds Ratios with 95% Wald Confidence Limits* table.](Bin.eas-4.png)

## Binomial Regression Model for Calf Vigor

![*Fit Statistics* and other tests.](Bin.vig-1.png)

![*Association of Predicted Probabilities and Observed Responses* and *Odds Ratio Estimates and Wald Confidence Intervals* tables.](Bin.vig-3.png)

![*Odds Ratios with 95% Wald Confidence Limits* table.](Bin.vig-4.png)

## Linear Mixed Model for Calf Final Body Weight

![*Differences of Least Squares Means* table.](Mixed%20Diff.png)

## ANCOVA for Calf Final Body Weight

![Tukey's HSD test and comparisons for ANCOVA model.](an.4.png)
